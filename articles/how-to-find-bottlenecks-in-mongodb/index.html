<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to Find Bottlenecks in MongoDB: Profiling and Load Testing Strategies with JMeter | André Brandão</title><meta name=keywords content="MongoDB,JMeter,Profiling,Performance,Load Testing"><meta name=description content="Knowing how to find bottlenecks in your application is a valuable skill when trying to scale to thousands or even millions of users."><meta name=author content="André Brandão"><link rel=canonical href=https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/><link crossorigin=anonymous href=/assets/css/stylesheet.ec761784c0ebcbe82a81d069b64757d486e1c7d1308693649d491da894d0e341.css integrity="sha256-7HYXhMDry+gqgdBptkdX1Ibhx9EwhpNknUkdqJTQ40E=" rel="preload stylesheet" as=style><link rel=icon href=https://andrebrandao.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://andrebrandao.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://andrebrandao.me/favicon-32x32.png><link rel=apple-touch-icon href=https://andrebrandao.me/apple-touch-icon.png><link rel=mask-icon href=https://andrebrandao.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="How to Find Bottlenecks in MongoDB: Profiling and Load Testing Strategies with JMeter"><meta property="og:description" content="Knowing how to find bottlenecks in your application is a valuable skill when trying to scale to thousands or even millions of users."><meta property="og:type" content="article"><meta property="og:url" content="https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/"><meta property="og:image" content="https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/media/how-to-find-bottlenecks-cover.png"><meta property="article:section" content="articles"><meta property="article:published_time" content="2023-05-21T20:17:37-03:00"><meta property="article:modified_time" content="2023-05-21T20:17:37-03:00"><meta property="og:site_name" content="André Brandão"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/media/how-to-find-bottlenecks-cover.png"><meta name=twitter:title content="How to Find Bottlenecks in MongoDB: Profiling and Load Testing Strategies with JMeter"><meta name=twitter:description content="Knowing how to find bottlenecks in your application is a valuable skill when trying to scale to thousands or even millions of users."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Articles","item":"https://andrebrandao.me/articles/"},{"@type":"ListItem","position":2,"name":"How to Find Bottlenecks in MongoDB: Profiling and Load Testing Strategies with JMeter","item":"https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"How to Find Bottlenecks in MongoDB: Profiling and Load Testing Strategies with JMeter","name":"How to Find Bottlenecks in MongoDB: Profiling and Load Testing Strategies with JMeter","description":"Knowing how to find bottlenecks in your application is a valuable skill when trying to scale to thousands or even millions of users.","keywords":["MongoDB","JMeter","Profiling","Performance","Load Testing"],"articleBody":"Introduction Knowing how to find bottlenecks in your application is a valuable skill when trying to scale to thousands or even millions of users. Some useful techniques for achieving this goal are load testing and profiling.\nIn this article, we will learn how to use JMeter to load test an e-commerce application and MongoDB Profiler to find slow queries. Additionally, we will apply the Extended Reference Pattern to optimize it.\nThese techniques have been proven effective in one of the companies I worked for, reducing latency of endpoints by 90% and decreasing MongoDB CPU usage from 20% to 3%. The results were instrumental in enabling an e-commerce platform to handle thousands of users during a Black Friday-like event.\nThe e-commerce application MongoStore is a simple e-commerce platform that operates in two regions of the world. It currently offers approximately 100,000 products in each region and has plans to expand to other locations.\nThe application is developed using Node.js, TypeScript, Serverless Framework, AWS, and MongoDB. Let’s examine its current implementation and architecture.\nℹ️ You can view the complete code here on GitHub along with deployment instructions.\nThe Product schema contains the sku, name, and description fields.\n1 2 3 4 5 6 7 8 const ProductSchema = new Schema\u003cIProduct\u003e( { sku: { type: String, required: true }, name: { type: String, required: true }, description: { type: String, required: true }, }, { timestamps: true }, ); Each region can have multiple products, and the prices are specified per region. In this case, the schema references the sku and price fields of the product.\n1 2 3 4 5 6 7 8 9 10 11 12 13 const RegionSchema = new Schema\u003cIRegion\u003e( { name: { type: String, required: true, index: true, unique: true }, products: [ { _id: { id: false }, sku: { type: String, required: true }, price: { type: Number, required: true }, }, ], }, { timestamps: true }, ); For its architecture, the application uses a MongoDB Cluster hosted on 3 EC2 instances. The servers employ AWS Lambda and are behind an API Gateway.\nWith this configuration, MongoStore can scale the backend servers using AWS Lambda. However, the database can still present scalability challenges since it does not scale automatically. Note: Auto-scaling has intentionally not been set up to identify database bottlenecks more effectively.\nProfiling with MongoDB Users have reported that the website is down, and CloudWatch data confirms that the database CPU usage has reached 100%. Consequently, it is likely that a database query is causing the issue.\nTo investigate further, you can utilize the MongoDB Database Profiler . The profiler collects data from MongoDB queries that exceed a specific threshold and stores it in the system.profile collection.\nConnect to the primary MongoDB instance and use Mongo Shell to execute the following command, which sets the data collection threshold to 100 ms:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 db.setProfilingLevel(1, 100) { \"was\" : 0, \"slowms\" : 100, \"sampleRate\" : 1, \"ok\" : 1, \"$clusterTime\" : { \"clusterTime\" : Timestamp(1683765280, 1), \"signature\" : { \"hash\" : BinData(0,\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"), \"keyId\" : NumberLong(0) } }, \"operationTime\" : Timestamp(1683765280, 1) } Now, retrieve the queries that have been executed and took longer than the threshold.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 db.system.profile.find().pretty() { \"op\" : \"command\", \"ns\" : \"database.regions\", \"command\" : { \"aggregate\" : \"regions\", \"pipeline\" : [ { \"$match\" : { \"_id\" : ObjectId(\"645c38d52f5c6ee098f9a392\") } }, { \"$unwind\" : \"$products\" }, { \"$lookup\" : { \"from\" : \"products\", \"localField\" : \"products.sku\", \"foreignField\" : \"sku\", \"as\" : \"products.product\" } }, { \"$unwind\" : \"$products.product\" }, { \"$limit\" : 100 }, { \"$project\" : { \"_id\" : \"$products.product._id\", \"sku\" : \"$products.product.sku\", \"name\" : \"$products.product.name\", \"description\" : \"$products.product.description\", \"price\" : \"$products.price\" } } ], \"cursor\" : { }, \"lsid\" : { \"id\" : UUID(\"d3e2a4d9-4970-4d80-917f-384be47acbd8\") }, \"$clusterTime\" : { \"clusterTime\" : Timestamp(1684015798, 1), \"signature\" : { \"hash\" : BinData(0,\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"), \"keyId\" : NumberLong(0) } }, \"$db\" : \"database\" }, \"keysExamined\" : 1, \"docsExamined\" : 20000001, \"cursorExhausted\" : true, \"numYield\" : 20000, \"nreturned\" : 100, \"queryHash\" : \"5B7E4F14\", \"planCacheKey\" : \"8928FB1D\", \"locks\" : { \"FeatureCompatibilityVersion\" : { \"acquireCount\" : { \"r\" : NumberLong(20203) } }, \"ReplicationStateTransition\" : { \"acquireCount\" : { \"w\" : NumberLong(1) } }, \"Global\" : { \"acquireCount\" : { \"r\" : NumberLong(20203) } }, \"Mutex\" : { \"acquireCount\" : { \"r\" : NumberLong(202) } } }, \"flowControl\" : { }, \"readConcern\" : { \"level\" : \"local\", \"provenance\" : \"implicitDefault\" }, \"writeConcern\" : { \"w\" : \"majority\", \"wtimeout\" : 0, \"provenance\" : \"implicitDefault\" }, \"storage\" : { }, \"responseLength\" : 21893, \"protocol\" : \"op_msg\", \"millis\" : 12095, \"planSummary\" : \"IDHACK\" } The whole operation took 12 seconds and by the variables keysExamined and docsExamined we can see that it only checked one index key and went through millions of documents.\nAfter some investigation, we noticed that we forgot to add the sku index to our products collection. Let’s do it.\n1 2 3 4 5 6 7 8 const ProductSchema = new Schema( { sku: { type: String, required: true, index: true, unique: true }, name: { type: String, required: true }, description: { type: String, required: true }, }, { timestamps: true }, ); Now, let’s set the threshold to a lower time to get the results. But, first, clear the db.system.profile database by disabling the profiler and enabling again.\n1 2 3 db.setProfilingLevel(0) # disable profile db.system.profile.drop() # drop profile database db.setProfilingLevel(1, 10) # set threshold to 10ms 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 db.system.profile.find().pretty() { \"op\" : \"command\", \"ns\" : \"database.regions\", \"command\" : { \"aggregate\" : \"regions\", \"pipeline\" : [ { \"$match\" : { \"_id\" : ObjectId(\"645c38d52f5c6ee098f9a392\") } }, { \"$unwind\" : \"$products\" }, { \"$lookup\" : { \"from\" : \"products\", \"localField\" : \"products.sku\", \"foreignField\" : \"sku\", \"as\" : \"products.product\" } }, { \"$unwind\" : \"$products.product\" }, { \"$limit\" : 100 }, { \"$project\" : { \"_id\" : \"$products.product._id\", \"sku\" : \"$products.product.sku\", \"name\" : \"$products.product.name\", \"description\" : \"$products.product.description\", \"price\" : \"$products.price\" } } ], \"cursor\" : { }, \"lsid\" : { \"id\" : UUID(\"cbbc0d5c-c35b-4428-8af6-d8b4a8ac0bd0\") }, \"$clusterTime\" : { \"clusterTime\" : Timestamp(1684015558, 1), \"signature\" : { \"hash\" : BinData(0,\"AAAAAAAAAAAAAAAAAAAAAAAAAAA=\"), \"keyId\" : NumberLong(0) } }, \"$db\" : \"database\" }, \"keysExamined\" : 101, \"docsExamined\" : 101, \"cursorExhausted\" : true, \"numYield\" : 0, \"nreturned\" : 100, \"queryHash\" : \"5B7E4F14\", \"planCacheKey\" : \"2FBA11A3\", \"locks\" : { \"FeatureCompatibilityVersion\" : { \"acquireCount\" : { \"r\" : NumberLong(203) } }, \"ReplicationStateTransition\" : { \"acquireCount\" : { \"w\" : NumberLong(1) } }, \"Global\" : { \"acquireCount\" : { \"r\" : NumberLong(203) } }, \"Mutex\" : { \"acquireCount\" : { \"r\" : NumberLong(202) } } }, \"flowControl\" : { }, \"readConcern\" : { \"level\" : \"local\", \"provenance\" : \"implicitDefault\" }, \"writeConcern\" : { \"w\" : \"majority\", \"wtimeout\" : 0, \"provenance\" : \"implicitDefault\" }, \"storage\" : { }, \"responseLength\" : 21893, \"protocol\" : \"op_msg\", \"millis\" : 29, \"planSummary\" : \"IDHACK } After adding the necessary index, the execution time dramatically reduced to only 29 milliseconds. Additionally, the number of keys and documents examined also decreased significantly. That is a lot better! And finally, our users have stopped seeing crashes in the app.\nLoad testing with jMeter Now that we fixed the bottleneck we had, we are confident that our system can handle thousands of users in a Black Friday, right? … WRONG!\nImproving just one endpoint and a database query does not guarantee we can handle the load we are expecting. One effective tool for load testing is Apache JMeter , which can simulate multiple users accessing and making requests to the system simultaneously.\nIn this scenario, let’s assume we are expecting 10,000 users are expected, with each user making approximately 1 request every 10 seconds to the endpoint responsible for fetching products. This translates to a requirement of 1,000 requests per second.\nTo validate the system’s ability to handle this expected throughput, follow these steps:\nRetrieve the ID of one of the regions using cURL . 1 2 curl https://3mspdgu8cb.execute-api.us-east-1.amazonaws.com/staging/regions {\"regions\":[{\"_id\":\"645c38d52f5c6ee098f9a392\",\"name\":\"Alaska\"},{\"_id\":\"645c39102f5c6ee098fcb0e9\",\"name\":\"Rio\"}]} Use the provided endpoint to fetch 100 products from the Alaska region. 1 https://3mspdgu8cb.execute-api.us-east-1.amazonaws.com/staging/regions/645c38d52f5c6ee098f9a392/products\\?limit\\=100 Create a Test Plan in JMeter using the Ultimate Thread Group plugin . Configure it to simulate 100 threads with a 30-second startup time, holding the load for 60 seconds. Configure the HTTP Request sampler in JMeter to target the appropriate endpoint. Additionaly, add the View Results Tree and Aggregate Report. Run the load tests. Upon executing the load tests, it is observed that the system only reaches approximately 20 requests per second before encountering 502 (Bad Gateway) errors.\nWhat does this mean? If we SSH into the machine and run sudo service mongod status we can see that the mongod service crashed, meaning it couldn’t handle the load.\n1 2 3 4 5 [ec2-user@ip-10-0-0-100 ~]$ sudo service mongod status Redirecting to /bin/systemctl status mongod.service ● mongod.service - MongoDB Database Server Loaded: loaded (/usr/lib/systemd/system/mongod.service; enabled; vendor preset: disabled) Active: failed (Result: exit-code) since Tue 2023-05-16 23:28:20 UTC; 474ms ago The question is, but our query is already using the correct indexes, it is not doing a Collection Scan, and it is executing in 29ms. Can we do better than this? Yes!\nThe Extended Reference Pattern When working with NoSQL databases, it is essential to understand that JOIN operations tend to be slow. In the context of this application, the $lookup step performed a join, negatively impacting the performance.\nTo mitigate this, it is valuable to be aware of the Extended Reference Pattern . This pattern involves copying only the necessary data into the collection, eliminating the need for joins and allowing querying a single collection for the required information.\nIt is also important to know that our first implementation had one drawback: having an array of products does not scale, because there is a limit of 16MB per document . Imagine if we had millions of products in each region? That array would grow quickly.\nTo address these concerns, the Extended Reference Pattern can be applied by embedding the regions and prices directly into the products collection. This design change involves introducing a new array, regions, which contains the _id of the region and the corresponding product’s price in that region.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 const ProductSchema = new Schema( { sku: { type: String, required: true, index: true, unique: true }, name: { type: String, required: true }, description: { type: String, required: true }, regions: [ { _id: { type: Schema.Types.ObjectId, required: true, index: true }, price: { type: Number, required: true }, }, ], }, { timestamps: true }, ); The application’s endpoint has been modified to utilize a new aggregate query that only queries the products collection, eliminating the need for additional lookups.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 export async function getProductsOptimized( regionId: string, limit: string | number, ): Promise","wordCount":"2221","inLanguage":"en","image":"https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/media/how-to-find-bottlenecks-cover.png","datePublished":"2023-05-21T20:17:37-03:00","dateModified":"2023-05-21T20:17:37-03:00","author":{"@type":"Person","name":"André Brandão"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/"},"publisher":{"@type":"Organization","name":"André Brandão","logo":{"@type":"ImageObject","url":"https://andrebrandao.me/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://andrebrandao.me/ accesskey=h title="André Brandão (Alt + H)">André Brandão</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://andrebrandao.me/articles/ title=Articles><span>Articles</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://andrebrandao.me/>Home</a>&nbsp;»&nbsp;<a href=https://andrebrandao.me/articles/>Articles</a></div><h1 class=post-title>How to Find Bottlenecks in MongoDB: Profiling and Load Testing Strategies with JMeter</h1><div class=post-meta><span title='2023-05-21 20:17:37 -0300 -0300'>May 21, 2023</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;André Brandão</div></header><figure class=entry-cover><img loading=lazy srcset="https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/media/how-to-find-bottlenecks-cover_huc2f9e86fbd6e48a5ab6b30f2a0deece0_108628_360x0_resize_box_3.png 360w ,https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/media/how-to-find-bottlenecks-cover_huc2f9e86fbd6e48a5ab6b30f2a0deece0_108628_480x0_resize_box_3.png 480w ,https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/media/how-to-find-bottlenecks-cover_huc2f9e86fbd6e48a5ab6b30f2a0deece0_108628_720x0_resize_box_3.png 720w ,https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/media/how-to-find-bottlenecks-cover_huc2f9e86fbd6e48a5ab6b30f2a0deece0_108628_1080x0_resize_box_3.png 1080w ,https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/media/how-to-find-bottlenecks-cover.png 1280w" sizes="(min-width: 768px) 720px, 100vw" src=https://andrebrandao.me/articles/how-to-find-bottlenecks-in-mongodb/media/how-to-find-bottlenecks-cover.png alt width=1280 height=720></figure><div class=post-content><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>Knowing how to find bottlenecks in your application is a valuable skill when trying to scale to thousands or even millions of users. Some useful techniques for achieving this goal are load testing and profiling.</p><p>In this article, we will learn how to use JMeter to load test an e-commerce application and MongoDB Profiler to find slow queries. Additionally, we will apply the Extended Reference Pattern to optimize it.</p><p>These techniques have been proven effective in one of the companies I worked for, reducing latency of endpoints by 90% and decreasing MongoDB CPU usage from 20% to 3%. The results were instrumental in enabling an e-commerce platform to handle thousands of users during a Black Friday-like event.</p><h2 id=the-e-commerce-application>The e-commerce application<a hidden class=anchor aria-hidden=true href=#the-e-commerce-application>#</a></h2><p>MongoStore is a simple e-commerce platform that operates in two regions of the world. It currently offers approximately 100,000 products in each region and has plans to expand to other locations.</p><p>The application is developed using Node.js, TypeScript, Serverless Framework, AWS, and MongoDB. Let&rsquo;s examine its current implementation and architecture.</p><blockquote><p>ℹ️ You can view the complete code <strong><a href=https://github.com/andrenbrandao/serverless-mongodb-performance-jmeter target=_blank>here on GitHub</a></strong>
along with deployment instructions.</p></blockquote><p>The Product schema contains the <strong><code>sku</code></strong>, <strong><code>name</code></strong>, and <strong><code>description</code></strong> fields.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#ff79c6>const</span> ProductSchema <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Schema&lt;<span style=color:#ff79c6>IProduct</span>&gt;(
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    sku<span style=color:#ff79c6>:</span> { <span style=color:#ff79c6>type</span><span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>String</span>, required: <span style=color:#8be9fd>true</span> },
</span></span><span style=display:flex><span>    name<span style=color:#ff79c6>:</span> { <span style=color:#ff79c6>type</span><span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>String</span>, required: <span style=color:#8be9fd>true</span> },
</span></span><span style=display:flex><span>    description<span style=color:#ff79c6>:</span> { <span style=color:#ff79c6>type</span><span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>String</span>, required: <span style=color:#8be9fd>true</span> },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  { timestamps: <span style=color:#8be9fd>true</span> },
</span></span><span style=display:flex><span>);
</span></span></code></pre></td></tr></table></div></div><p>Each region can have multiple products, and the prices are specified per region. In this case, the schema references the <strong><code>sku</code></strong> and <strong><code>price</code></strong> fields of the product.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tsx data-lang=tsx><span style=display:flex><span><span style=color:#ff79c6>const</span> RegionSchema <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> Schema&lt;<span style=color:#ff79c6>IRegion</span>&gt;(
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    name<span style=color:#ff79c6>:</span> { <span style=color:#ff79c6>type</span><span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>String</span>, required: <span style=color:#8be9fd>true</span>, index: <span style=color:#8be9fd>true</span>, <span style=color:#8be9fd>unique</span><span style=color:#ff79c6>:</span> <span style=color:#ff79c6>true</span> },
</span></span><span style=display:flex><span>    products<span style=color:#ff79c6>:</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        _id<span style=color:#ff79c6>:</span> { id: <span style=color:#8be9fd>false</span> },
</span></span><span style=display:flex><span>        sku<span style=color:#ff79c6>:</span> { <span style=color:#ff79c6>type</span><span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>String</span>, required: <span style=color:#8be9fd>true</span> },
</span></span><span style=display:flex><span>        price<span style=color:#ff79c6>:</span> { <span style=color:#ff79c6>type</span><span style=color:#ff79c6>:</span> <span style=color:#8be9fd;font-style:italic>Number</span>, required: <span style=color:#8be9fd>true</span> },
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  { timestamps: <span style=color:#8be9fd>true</span> },
</span></span><span style=display:flex><span>);
</span></span></code></pre></td></tr></table></div></div><p>For its architecture, the application uses a MongoDB Cluster hosted on 3 EC2 instances. The servers employ AWS Lambda and are behind an API Gateway.</p><p>With this configuration, MongoStore can scale the backend servers using AWS Lambda. However, the database can still present scalability challenges since it does not scale automatically. Note: Auto-scaling has intentionally not been set up to identify database bottlenecks more effectively.</p><p><img loading=lazy src=media/1.jpg alt="AWS Architecture Image"></p><h2 id=profiling-with-mongodb>Profiling with MongoDB<a hidden class=anchor aria-hidden=true href=#profiling-with-mongodb>#</a></h2><p>Users have reported that the website is down, and CloudWatch data confirms that the database CPU usage has reached 100%. Consequently, it is likely that a database query is causing the issue.</p><p>To investigate further, you can utilize the <strong><strong><a href=https://www.mongodb.com/docs/manual/tutorial/manage-the-database-profiler/ target=_blank>MongoDB Database Profiler</a></strong>
</strong>. The profiler collects data from MongoDB queries that exceed a specific threshold and stores it in the <strong><code>system.profile</code></strong> collection.</p><p>Connect to the primary MongoDB instance and use <strong><strong><a href=https://www.mongodb.com/docs/v4.4/mongo/ target=_blank>Mongo Shell</a></strong></strong> to execute the following command, which sets the data collection threshold to 100 ms:</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>db.setProfilingLevel<span style=color:#ff79c6>(</span>1, 100<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;was&#34;</span> : 0,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;slowms&#34;</span> : 100,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;sampleRate&#34;</span> : 1,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;ok&#34;</span> : 1,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$clusterTime</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;clusterTime&#34;</span> : Timestamp<span style=color:#ff79c6>(</span>1683765280, 1<span style=color:#ff79c6>)</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;signature&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;hash&#34;</span> : BinData<span style=color:#ff79c6>(</span>0,<span style=color:#f1fa8c>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&#34;</span><span style=color:#ff79c6>)</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;keyId&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;operationTime&#34;</span> : Timestamp<span style=color:#ff79c6>(</span>1683765280, 1<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Now, retrieve the queries that have been executed and took longer than the threshold.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>db.system.profile.find<span style=color:#ff79c6>()</span>.pretty<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;op&#34;</span> : <span style=color:#f1fa8c>&#34;command&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;ns&#34;</span> : <span style=color:#f1fa8c>&#34;database.regions&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;command&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;aggregate&#34;</span> : <span style=color:#f1fa8c>&#34;regions&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;pipeline&#34;</span> : <span style=color:#ff79c6>[</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$match</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;_id&#34;</span> : ObjectId<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;645c38d52f5c6ee098f9a392&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$unwind</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$lookup</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;from&#34;</span> : <span style=color:#f1fa8c>&#34;products&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;localField&#34;</span> : <span style=color:#f1fa8c>&#34;products.sku&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;foreignField&#34;</span> : <span style=color:#f1fa8c>&#34;sku&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;as&#34;</span> : <span style=color:#f1fa8c>&#34;products.product&#34;</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$unwind</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$limit</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$project</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;_id&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product._id&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;sku&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product.sku&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;name&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product.name&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;description&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product.description&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;price&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.price&#34;</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;cursor&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;lsid&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;id&#34;</span> : UUID<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;d3e2a4d9-4970-4d80-917f-384be47acbd8&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$clusterTime</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;clusterTime&#34;</span> : Timestamp<span style=color:#ff79c6>(</span>1684015798, 1<span style=color:#ff79c6>)</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;signature&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;hash&#34;</span> : BinData<span style=color:#ff79c6>(</span>0,<span style=color:#f1fa8c>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&#34;</span><span style=color:#ff79c6>)</span>,
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;keyId&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$db</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#f1fa8c>&#34;database&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;keysExamined&#34;</span> : 1,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;docsExamined&#34;</span> : 20000001,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;cursorExhausted&#34;</span> : true,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;numYield&#34;</span> : 20000,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;nreturned&#34;</span> : 100,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;queryHash&#34;</span> : <span style=color:#f1fa8c>&#34;5B7E4F14&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;planCacheKey&#34;</span> : <span style=color:#f1fa8c>&#34;8928FB1D&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;locks&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;FeatureCompatibilityVersion&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;acquireCount&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;r&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>20203<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;ReplicationStateTransition&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;acquireCount&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;w&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Global&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;acquireCount&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;r&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>20203<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Mutex&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;acquireCount&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;r&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>202<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;flowControl&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;readConcern&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;level&#34;</span> : <span style=color:#f1fa8c>&#34;local&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;provenance&#34;</span> : <span style=color:#f1fa8c>&#34;implicitDefault&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;writeConcern&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;w&#34;</span> : <span style=color:#f1fa8c>&#34;majority&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;wtimeout&#34;</span> : 0,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;provenance&#34;</span> : <span style=color:#f1fa8c>&#34;implicitDefault&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;storage&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;responseLength&#34;</span> : 21893,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;protocol&#34;</span> : <span style=color:#f1fa8c>&#34;op_msg&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;millis&#34;</span> : 12095,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;planSummary&#34;</span> : <span style=color:#f1fa8c>&#34;IDHACK&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></td></tr></table></div></div><p>The whole operation took 12 seconds and by the variables <code>keysExamined</code> and <code>docsExamined</code> we can see that it only checked one index key and went through millions of documents.</p><p>After some investigation, we noticed that we forgot to add the <code>sku</code> index to our <code>products</code> collection. Let’s do it.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>const <span style=color:#8be9fd;font-style:italic>ProductSchema</span> <span style=color:#ff79c6>=</span> new Schema&lt;IProduct&gt;<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    sku: <span style=color:#ff79c6>{</span> type: String, required: true, index: true, unique: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    name: <span style=color:#ff79c6>{</span> type: String, required: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    description: <span style=color:#ff79c6>{</span> type: String, required: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>{</span> timestamps: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span><span style=color:#ff79c6>)</span>;
</span></span></code></pre></td></tr></table></div></div><p>Now, let’s set the threshold to a lower time to get the results. But, first, clear the <code>db.system.profile</code> database by disabling the profiler and enabling again.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>db.setProfilingLevel<span style=color:#ff79c6>(</span>0<span style=color:#ff79c6>)</span> <span style=color:#6272a4># disable profile</span>
</span></span><span style=display:flex><span>db.system.profile.drop<span style=color:#ff79c6>()</span> <span style=color:#6272a4># drop profile database</span>
</span></span><span style=display:flex><span>db.setProfilingLevel<span style=color:#ff79c6>(</span>1, 10<span style=color:#ff79c6>)</span> <span style=color:#6272a4># set threshold to 10ms</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>db.system.profile.find<span style=color:#ff79c6>()</span>.pretty<span style=color:#ff79c6>()</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;op&#34;</span> : <span style=color:#f1fa8c>&#34;command&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;ns&#34;</span> : <span style=color:#f1fa8c>&#34;database.regions&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;command&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;aggregate&#34;</span> : <span style=color:#f1fa8c>&#34;regions&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;pipeline&#34;</span> : <span style=color:#ff79c6>[</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$match</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;_id&#34;</span> : ObjectId<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;645c38d52f5c6ee098f9a392&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$unwind</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$lookup</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;from&#34;</span> : <span style=color:#f1fa8c>&#34;products&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;localField&#34;</span> : <span style=color:#f1fa8c>&#34;products.sku&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;foreignField&#34;</span> : <span style=color:#f1fa8c>&#34;sku&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;as&#34;</span> : <span style=color:#f1fa8c>&#34;products.product&#34;</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$unwind</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product&#34;</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$limit</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#bd93f9>100</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$project</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;_id&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product._id&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;sku&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product.sku&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;name&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product.name&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;description&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.product.description&#34;</span>,
</span></span><span style=display:flex><span>                                        <span style=color:#f1fa8c>&#34;price&#34;</span> : <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$products</span><span style=color:#f1fa8c>.price&#34;</span>
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;cursor&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;lsid&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;id&#34;</span> : UUID<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;cbbc0d5c-c35b-4428-8af6-d8b4a8ac0bd0&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$clusterTime</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;clusterTime&#34;</span> : Timestamp<span style=color:#ff79c6>(</span>1684015558, 1<span style=color:#ff79c6>)</span>,
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;signature&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;hash&#34;</span> : BinData<span style=color:#ff79c6>(</span>0,<span style=color:#f1fa8c>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&#34;</span><span style=color:#ff79c6>)</span>,
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;keyId&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>0<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;</span><span style=color:#8be9fd;font-style:italic>$db</span><span style=color:#f1fa8c>&#34;</span> : <span style=color:#f1fa8c>&#34;database&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;keysExamined&#34;</span> : 101,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;docsExamined&#34;</span> : 101,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;cursorExhausted&#34;</span> : true,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;numYield&#34;</span> : 0,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;nreturned&#34;</span> : 100,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;queryHash&#34;</span> : <span style=color:#f1fa8c>&#34;5B7E4F14&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;planCacheKey&#34;</span> : <span style=color:#f1fa8c>&#34;2FBA11A3&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;locks&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;FeatureCompatibilityVersion&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;acquireCount&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;r&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>203<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;ReplicationStateTransition&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;acquireCount&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;w&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>1<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Global&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;acquireCount&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;r&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>203<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;Mutex&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;acquireCount&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                                <span style=color:#f1fa8c>&#34;r&#34;</span> : NumberLong<span style=color:#ff79c6>(</span>202<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;flowControl&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;readConcern&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;level&#34;</span> : <span style=color:#f1fa8c>&#34;local&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;provenance&#34;</span> : <span style=color:#f1fa8c>&#34;implicitDefault&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;writeConcern&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;w&#34;</span> : <span style=color:#f1fa8c>&#34;majority&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;wtimeout&#34;</span> : 0,
</span></span><span style=display:flex><span>                <span style=color:#f1fa8c>&#34;provenance&#34;</span> : <span style=color:#f1fa8c>&#34;implicitDefault&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;storage&#34;</span> : <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;responseLength&#34;</span> : 21893,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;protocol&#34;</span> : <span style=color:#f1fa8c>&#34;op_msg&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;millis&#34;</span> : 29,
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#34;planSummary&#34;</span> : <span style=color:#f1fa8c>&#34;IDHACK
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>}
</span></span></span></code></pre></td></tr></table></div></div><p>After adding the necessary index, the execution time dramatically reduced to only 29 milliseconds. Additionally, the number of keys and documents examined also decreased significantly. That is a lot better! And finally, our users have stopped seeing crashes in the app.</p><h2 id=load-testing-with-jmeter>Load testing with jMeter<a hidden class=anchor aria-hidden=true href=#load-testing-with-jmeter>#</a></h2><p>Now that we fixed the bottleneck we had, we are confident that our system can handle thousands of users in a Black Friday, right? … <strong>WRONG!</strong></p><p>Improving just one endpoint and a database query does not guarantee we can handle the load we are expecting. One effective tool for load testing is <strong><a href=https://jmeter.apache.org/ target=_blank>Apache JMeter</a></strong>
, which can simulate multiple users accessing and making requests to the system simultaneously.</p><p>In this scenario, let’s assume we are expecting 10,000 users are expected, with each user making approximately 1 request every 10 seconds to the endpoint responsible for fetching products. This translates to a requirement of 1,000 requests per second.</p><p>To validate the system&rsquo;s ability to handle this expected throughput, follow these steps:</p><ol><li>Retrieve the ID of one of the regions using <strong><a href=https://curl.se/ target=_blank>cURL</a></strong>
.</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://3mspdgu8cb.execute-api.us-east-1.amazonaws.com/staging/regions
</span></span><span style=display:flex><span><span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;regions&#34;</span>:<span style=color:#ff79c6>[{</span><span style=color:#f1fa8c>&#34;_id&#34;</span>:<span style=color:#f1fa8c>&#34;645c38d52f5c6ee098f9a392&#34;</span>,<span style=color:#f1fa8c>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;Alaska&#34;</span><span style=color:#ff79c6>}</span>,<span style=color:#ff79c6>{</span><span style=color:#f1fa8c>&#34;_id&#34;</span>:<span style=color:#f1fa8c>&#34;645c39102f5c6ee098fcb0e9&#34;</span>,<span style=color:#f1fa8c>&#34;name&#34;</span>:<span style=color:#f1fa8c>&#34;Rio&#34;</span><span style=color:#ff79c6>}]}</span>
</span></span></code></pre></td></tr></table></div></div><ol start=2><li>Use the provided endpoint to fetch 100 products from the Alaska region.</li></ol><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>https://3mspdgu8cb.execute-api.us-east-1.amazonaws.com/staging/regions/645c38d52f5c6ee098f9a392/products<span style=color:#f1fa8c>\?</span>limit<span style=color:#f1fa8c>\=</span><span style=color:#bd93f9>100</span>
</span></span></code></pre></td></tr></table></div></div><ol start=3><li>Create a Test Plan in JMeter using the <strong><a href=https://jmeter-plugins.org/wiki/UltimateThreadGroup/ target=_blank>Ultimate Thread Group plugin</a></strong>
. Configure it to simulate 100 threads with a 30-second startup time, holding the load for 60 seconds.</li></ol><p><img loading=lazy src=media/2.png alt="Ultimate Thread Group Screenshot"></p><ol start=4><li>Configure the HTTP Request sampler in JMeter to target the appropriate endpoint. Additionaly, add the View Results Tree and Aggregate Report.</li></ol><p><img loading=lazy src=media/3.png alt="HTTP Request Sampler"></p><ol start=5><li>Run the load tests.</li></ol><p><img loading=lazy src=media/4.png alt="Aggregate Report"></p><p><img loading=lazy src=media/5.png alt="View Results Tree"></p><p>Upon executing the load tests, it is observed that the system only reaches approximately 20 requests per second before encountering 502 (Bad Gateway) errors.</p><p>What does this mean? If we SSH into the machine and run <code>sudo service mongod status</code> we can see that the <code>mongod</code> service crashed, meaning it couldn’t handle the load.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ff79c6>[</span>ec2-user@ip-10-0-0-100 ~<span style=color:#ff79c6>]</span>$ sudo service mongod status
</span></span><span style=display:flex><span>Redirecting to /bin/systemctl status mongod.service
</span></span><span style=display:flex><span>● mongod.service - MongoDB Database Server
</span></span><span style=display:flex><span>   Loaded: loaded <span style=color:#ff79c6>(</span>/usr/lib/systemd/system/mongod.service; enabled; vendor preset: disabled<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>   Active: failed <span style=color:#ff79c6>(</span>Result: exit-code<span style=color:#ff79c6>)</span> since Tue 2023-05-16 23:28:20 UTC; 474ms ago
</span></span></code></pre></td></tr></table></div></div><p>The question is, but our query is already using the correct indexes, it is not doing a Collection Scan, and it is executing in 29ms. Can we do better than this? <strong>Yes!</strong></p><h2 id=the-extended-reference-pattern>The Extended Reference Pattern<a hidden class=anchor aria-hidden=true href=#the-extended-reference-pattern>#</a></h2><p>When working with NoSQL databases, it is essential to understand that JOIN operations tend to be slow. In the context of this application, the <strong><code>$lookup</code></strong> step performed a join, negatively impacting the performance.</p><p>To mitigate this, it is valuable to be aware of the <strong><a href=https://www.mongodb.com/blog/post/building-with-patterns-the-extended-reference-pattern target=_blank>Extended Reference Pattern</a></strong>
. This pattern involves copying only the necessary data into the collection, eliminating the need for joins and allowing querying a single collection for the required information.</p><p>It is also important to know that our first implementation had one drawback: having an array of products does not scale, because there is a <strong><a href=https://www.mongodb.com/docs/manual/reference/limits/#mongodb-limit-BSON-Document-Size target=_blank>limit of 16MB per document</a></strong>
. Imagine if we had millions of products in each region? That array would grow quickly.</p><p>To address these concerns, the Extended Reference Pattern can be applied by embedding the regions and prices directly into the products collection. This design change involves introducing a new array, <strong><code>regions</code></strong>, which contains the <strong><code>_id</code></strong> of the region and the corresponding product&rsquo;s price in that region.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>const <span style=color:#8be9fd;font-style:italic>ProductSchema</span> <span style=color:#ff79c6>=</span> new Schema&lt;IProduct&gt;<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    sku: <span style=color:#ff79c6>{</span> type: String, required: true, index: true, unique: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    name: <span style=color:#ff79c6>{</span> type: String, required: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    description: <span style=color:#ff79c6>{</span> type: String, required: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    regions: <span style=color:#ff79c6>[</span>
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        _id: <span style=color:#ff79c6>{</span> type: Schema.Types.ObjectId, required: true, index: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>        price: <span style=color:#ff79c6>{</span> type: Number, required: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>]</span>,
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>{</span> timestamps: <span style=color:#8be9fd;font-style:italic>true</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span><span style=color:#ff79c6>)</span>;
</span></span></code></pre></td></tr></table></div></div><p>The application&rsquo;s endpoint has been modified to utilize a new aggregate query that only queries the <strong><code>products</code></strong> collection, eliminating the need for additional lookups.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>export</span> async <span style=color:#ff79c6>function</span> getProductsOptimized<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>  regionId: string,
</span></span><span style=display:flex><span>  limit: string | number,
</span></span><span style=display:flex><span><span style=color:#ff79c6>)</span>: Promise&lt;IProduct<span style=color:#ff79c6>[]</span>&gt; <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>  const <span style=color:#8be9fd;font-style:italic>mongoRegionId</span> <span style=color:#ff79c6>=</span> new mongoose.Types.ObjectId<span style=color:#ff79c6>(</span>regionId<span style=color:#ff79c6>)</span>;
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>return</span> Product.aggregate<span style=color:#ff79c6>([</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>{</span> <span style=color:#8be9fd;font-style:italic>$match</span>: <span style=color:#ff79c6>{</span> regions: <span style=color:#ff79c6>{</span> <span style=color:#8be9fd;font-style:italic>$elemMatch</span>: <span style=color:#ff79c6>{</span> _id: mongoRegionId <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>}</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>{</span> <span style=color:#8be9fd;font-style:italic>$limit</span>: Number<span style=color:#ff79c6>(</span>limit<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>$unwind</span>: <span style=color:#f1fa8c>&#39;$regions&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>$match</span>: <span style=color:#ff79c6>{</span> <span style=color:#f1fa8c>&#39;regions._id&#39;</span>: mongoRegionId <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>$project</span>: <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        _id: 1,
</span></span><span style=display:flex><span>        sku: 1,
</span></span><span style=display:flex><span>        name: 1,
</span></span><span style=display:flex><span>        description: 1,
</span></span><span style=display:flex><span>        price: <span style=color:#f1fa8c>&#39;$regions.price&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>,
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>])</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Upon retesting the endpoint with the optimized query using the <strong><code>optimized=true</code></strong> query string parameter, the system demonstrates a significant improvement. The aggregate report shows that the throughput has increased to 80 requests per second, representing a 400% improvement.</p><p><img loading=lazy src=media/6.png alt="HTTP Request Sampler"></p><p><img loading=lazy src=media/7.png alt="Aggregate Report"></p><p>While this improvement is substantial, it is still short of the required throughput of 1,000 requests per second. To handle such loads, additional strategies can be employed, such as vertically scaling the EC2 instances by adding more CPU and RAM, distributing the load across multiple replicas, or even sharding the database.</p><h3 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h3><p>By utilizing MongoDB&rsquo;s profiling capabilities for query optimization, load testing with tools like Apache JMeter, and applying effective design patterns like the Extended Reference Pattern, it is possible to significantly improve the performance and scalability of the application.</p><p>Additionally, implementing observability practices, including monitoring, logging, and alerting, allows for proactive identification and resolution of performance bottlenecks.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://andrebrandao.me/tags/mongodb/>MongoDB</a></li><li><a href=https://andrebrandao.me/tags/jmeter/>JMeter</a></li><li><a href=https://andrebrandao.me/tags/profiling/>Profiling</a></li><li><a href=https://andrebrandao.me/tags/performance/>Performance</a></li><li><a href=https://andrebrandao.me/tags/load-testing/>Load Testing</a></li></ul><nav class=paginav><a class=next href=https://andrebrandao.me/articles/terminal-setup-with-zsh-tmux-dracula-theme/><span class=title>Next »</span><br><span>Terminal Setup with Zsh + Tmux + Dracula Theme</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://andrebrandao.me/>André Brandão</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById("menu");menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>